angular.module("ez.datetimepicker",[]).constant("EzDatetimepickerConfig",{pickDate:!0,pickTime:!0,useMinutes:!0,useSeconds:!1,useCurrent:!0,minuteStepping:1,minDate:new moment({y:1900}),maxDate:(new moment).add(100,"y"),showToday:!0,collapse:!0,language:"en",defaultDate:"",disabledDates:!1,enabledDates:!1,useStrict:!1,direction:"auto",sideBySide:!1,daysOfWeekDisabled:!1,icons:{time:"glyphicon glyphicon-time",date:"glyphicon glyphicon-calendar",up:"glyphicon glyphicon-chevron-up",down:"glyphicon glyphicon-chevron-down"}}).directive("ezDatetimepicker",["EzDatetimepickerConfig",function(a){return{restrict:"EA",require:"?ngModel",compile:function(){return function(b,c,d){if("undefined"==typeof moment)throw new Error("momentjs is required");var e=0,f=moment,g=this,h=function(){var h,j=!1;if(g.options=$.extend(!0,{},a,b.$eval(d.config)),g.element=c,!g.options.pickTime&&!g.options.pickDate)throw new Error("Must choose at least one picker");if(g.id=e++,f.lang(g.options.language),g.date=f(),g.unset=!1,g.isInput=g.element.is("input"),g.component=!1,g.element.hasClass("input-group")&&(g.component=g.element.find(0===g.element.find(".datepickerbutton").size()?'[class^="input-group-"]':".datepickerbutton")),g.format=g.options.format,h=f()._lang._longDateFormat,g.format||(g.format=g.options.pickDate?h.L:"",g.options.pickDate&&g.options.pickTime&&(g.format+=" "),g.format+=g.options.pickTime?h.LT:"",g.options.useSeconds&&(h.LT.indexOf(" A")?g.format=g.format.split(" A")[0]+":ss A":g.format+=":ss")),g.use24hours=g.format.toLowerCase().indexOf("a")<1,g.component&&(j=g.component.find("span")),g.options.pickTime&&j&&j.addClass(g.options.icons.time),g.options.pickDate&&j&&(j.removeClass(g.options.icons.time),j.addClass(g.options.icons.date)),g.widget=$(L()).appendTo("body"),g.options.useSeconds&&!g.use24hours&&g.widget.width(300),g.minViewMode=g.options.minViewMode||0,"string"==typeof g.minViewMode)switch(g.minViewMode){case"months":g.minViewMode=1;break;case"years":g.minViewMode=2;break;default:g.minViewMode=0}if(g.viewMode=g.options.viewMode||0,"string"==typeof g.viewMode)switch(g.viewMode){case"months":g.viewMode=1;break;case"years":g.viewMode=2;break;default:g.viewMode=0}if(g.options.disabledDates=J(g.options.disabledDates),g.options.enabledDates=J(g.options.enabledDates),g.startViewMode=g.viewMode,g.setMinDate(g.options.minDate),g.setMaxDate(g.options.maxDate),n(),o(),q(),r(),s(),m(),z(),A(),""!==g.options.defaultDate&&""===i().val()&&g.setValue(g.options.defaultDate),1!==g.options.minuteStepping){var k=g.options.minuteStepping;g.date.minutes(Math.round(g.date.minutes()/k)*k%60).seconds(0)}},i=function(){return g.isInput?g.element:g.element.find("input")},j=function(){var a,b="absolute",c=g.component?g.component.offset():g.element.offset(),d=$(window);g.width=g.component?g.component.outerWidth():g.element.outerWidth(),c.top=c.top+g.element.outerHeight(),"up"===g.options.direction?a="top":"bottom"===g.options.direction?a="bottom":"auto"===g.options.direction&&(a=c.top+g.widget.height()>d.height()+d.scrollTop()&&g.widget.height()+g.element.outerHeight()<c.top?"top":"bottom"),"top"===a?(c.top-=g.widget.height()+g.element.outerHeight()+15,g.widget.addClass("top").removeClass("bottom")):(c.top+=1,g.widget.addClass("bottom").removeClass("top")),void 0!==g.options.width&&g.widget.width(g.options.width),"left"===g.options.orientation&&(g.widget.addClass("left-oriented"),c.left=c.left-g.widget.width()+20),E()&&(b="fixed",c.top-=d.scrollTop(),c.left-=d.scrollLeft()),d.width()<c.left+g.widget.outerWidth()?(c.right=d.width()-c.left-g.width,c.left="auto",g.widget.addClass("pull-right")):(c.right="auto",g.widget.removeClass("pull-right")),g.widget.css({position:b,top:c.top,left:c.left,right:c.right})},k=function(a,b){f(g.date).isSame(f(a))||(g.element.trigger({type:"dp.change",date:f(g.date),oldDate:f(a)}),"change"!==b&&g.element.change())},l=function(a){g.element.trigger({type:"dp.error",date:f(a)})},m=function(a){f.lang(g.options.language);var b=a;b||(b=i().val(),b&&(g.date=f(b,g.format,g.options.useStrict)),g.date||(g.date=f())),g.viewDate=f(g.date).startOf("month"),p(),t()},n=function(){f.lang(g.options.language);var a,b=$("<tr>"),c=f.weekdaysMin();if(0===f()._lang._week.dow)for(a=0;7>a;a++)b.append('<th class="dow">'+c[a]+"</th>");else for(a=1;8>a;a++)b.append(7===a?'<th class="dow">'+c[0]+"</th>":'<th class="dow">'+c[a]+"</th>");g.widget.find(".datepicker-days thead").append(b)},o=function(){f.lang(g.options.language);for(var a="",b=0,c=f.monthsShort();12>b;)a+='<span class="month">'+c[b++]+"</span>";g.widget.find(".datepicker-months td").append(a)},p=function(){f.lang(g.options.language);var a,b,c,d,e,h,i,j,k=g.viewDate.year(),l=g.viewDate.month(),m=g.options.minDate.year(),n=g.options.minDate.month(),o=g.options.maxDate.year(),p=g.options.maxDate.month(),q=[],r=f.months();for(g.widget.find(".datepicker-days").find(".disabled").removeClass("disabled"),g.widget.find(".datepicker-months").find(".disabled").removeClass("disabled"),g.widget.find(".datepicker-years").find(".disabled").removeClass("disabled"),g.widget.find(".datepicker-days th:eq(1)").text(r[l]+" "+k),a=f(g.viewDate).subtract("months",1),h=a.daysInMonth(),a.date(h).startOf("week"),(k===m&&n>=l||m>k)&&g.widget.find(".datepicker-days th:eq(0)").addClass("disabled"),(k===o&&l>=p||k>o)&&g.widget.find(".datepicker-days th:eq(2)").addClass("disabled"),b=f(a).add(42,"d");a.isBefore(b);){if(a.weekday()===f().startOf("week").weekday()&&(c=$("<tr>"),q.push(c)),d="",a.year()<k||a.year()===k&&a.month()<l?d+=" old":(a.year()>k||a.year()===k&&a.month()>l)&&(d+=" new"),a.isSame(f({y:g.date.year(),M:g.date.month(),d:g.date.date()}))&&(d+=" active"),(H(a)||!I(a))&&(d+=" disabled"),g.options.showToday===!0&&a.isSame(f(),"day")&&(d+=" today"),g.options.daysOfWeekDisabled)for(e in g.options.daysOfWeekDisabled)if(a.day()===g.options.daysOfWeekDisabled[e]){d+=" disabled";break}c.append('<td class="day'+d+'">'+a.date()+"</td>"),a.add(1,"d")}for(g.widget.find(".datepicker-days tbody").empty().append(q),j=g.date.year(),r=g.widget.find(".datepicker-months").find("th:eq(1)").text(k).end().find("span").removeClass("active"),j===k&&r.eq(g.date.month()).addClass("active"),m>j-1&&g.widget.find(".datepicker-months th:eq(0)").addClass("disabled"),j+1>o&&g.widget.find(".datepicker-months th:eq(2)").addClass("disabled"),e=0;12>e;e++)k===m&&n>e||m>k?$(r[e]).addClass("disabled"):(k===o&&e>p||k>o)&&$(r[e]).addClass("disabled");for(q="",k=10*parseInt(k/10,10),i=g.widget.find(".datepicker-years").find("th:eq(1)").text(k+"-"+(k+9)).end().find("td"),g.widget.find(".datepicker-years").find("th").removeClass("disabled"),m>k&&g.widget.find(".datepicker-years").find("th:eq(0)").addClass("disabled"),k+9>o&&g.widget.find(".datepicker-years").find("th:eq(2)").addClass("disabled"),k-=1,e=-1;11>e;e++)q+='<span class="year'+(-1===e||10===e?" old":"")+(j===k?" active":"")+(m>k||k>o?" disabled":"")+'">'+k+"</span>",k+=1;i.html(q)},q=function(){f.lang(g.options.language);var a,b,c,d=g.widget.find(".timepicker .timepicker-hours table"),e="";if(d.parent().hide(),g.use24hours)for(a=0,b=0;6>b;b+=1){for(e+="<tr>",c=0;4>c;c+=1)e+='<td class="hour">'+K(a.toString())+"</td>",a++;e+="</tr>"}else for(a=1,b=0;3>b;b+=1){for(e+="<tr>",c=0;4>c;c+=1)e+='<td class="hour">'+K(a.toString())+"</td>",a++;e+="</tr>"}d.html(e)},r=function(){var a,b,c=g.widget.find(".timepicker .timepicker-minutes table"),d="",e=0,f=g.options.minuteStepping;for(c.parent().hide(),1===f&&(f=5),a=0;a<Math.ceil(60/f/4);a++){for(d+="<tr>",b=0;4>b;b+=1)60>e?(d+='<td class="minute">'+K(e.toString())+"</td>",e+=f):d+="<td></td>";d+="</tr>"}c.html(d)},s=function(){var a,b,c=g.widget.find(".timepicker .timepicker-seconds table"),d="",e=0;for(c.parent().hide(),a=0;3>a;a++){for(d+="<tr>",b=0;4>b;b+=1)d+='<td class="second">'+K(e.toString())+"</td>",e+=5;d+="</tr>"}c.html(d)},t=function(){if(g.date){var a=g.widget.find(".timepicker span[data-time-component]"),b=g.date.hours(),c="AM";g.use24hours||(b>=12&&(c="PM"),0===b?b=12:12!==b&&(b%=12),g.widget.find(".timepicker [data-action=togglePeriod]").text(c)),a.filter("[data-time-component=hours]").text(K(b)),a.filter("[data-time-component=minutes]").text(K(g.date.minutes())),a.filter("[data-time-component=seconds]").text(K(g.date.second()))}},u=function(a){a.stopPropagation(),a.preventDefault(),g.unset=!1;var b,c,d,e,h=$(a.target).closest("span, td, th"),i=f(g.date);if(1===h.length&&!h.is(".disabled"))switch(h[0].nodeName.toLowerCase()){case"th":switch(h[0].className){case"switch":z(1);break;case"prev":case"next":d=M.modes[g.viewMode].navStep,"prev"===h[0].className&&(d=-1*d),g.viewDate.add(d,M.modes[g.viewMode].navFnc),p()}break;case"span":h.is(".month")?(b=h.parent().find("span").index(h),g.viewDate.month(b)):(c=parseInt(h.text(),10)||0,g.viewDate.year(c)),g.viewMode===g.minViewMode&&(g.date=f({y:g.viewDate.year(),M:g.viewDate.month(),d:g.viewDate.date(),h:g.date.hours(),m:g.date.minutes(),s:g.date.seconds()}),k(i,a.type),F()),z(-1),p();break;case"td":h.is(".day")&&(e=parseInt(h.text(),10)||1,b=g.viewDate.month(),c=g.viewDate.year(),h.is(".old")?0===b?(b=11,c-=1):b-=1:h.is(".new")&&(11===b?(b=0,c+=1):b+=1),g.date=f({y:c,M:b,d:e,h:g.date.hours(),m:g.date.minutes(),s:g.date.seconds()}),g.viewDate=f({y:c,M:b,d:Math.min(28,e)}),p(),F(),k(i,a.type))}},v={incrementHours:function(){G("add","hours",1)},incrementMinutes:function(){G("add","minutes",g.options.minuteStepping)},incrementSeconds:function(){G("add","seconds",1)},decrementHours:function(){G("subtract","hours",1)},decrementMinutes:function(){G("subtract","minutes",g.options.minuteStepping)},decrementSeconds:function(){G("subtract","seconds",1)},togglePeriod:function(){var a=g.date.hours();a>=12?a-=12:a+=12,g.date.hours(a)},showPicker:function(){g.widget.find(".timepicker > div:not(.timepicker-picker)").hide(),g.widget.find(".timepicker .timepicker-picker").show()},showHours:function(){g.widget.find(".timepicker .timepicker-picker").hide(),g.widget.find(".timepicker .timepicker-hours").show()},showMinutes:function(){g.widget.find(".timepicker .timepicker-picker").hide(),g.widget.find(".timepicker .timepicker-minutes").show()},showSeconds:function(){g.widget.find(".timepicker .timepicker-picker").hide(),g.widget.find(".timepicker .timepicker-seconds").show()},selectHour:function(a){var b=g.widget.find(".timepicker [data-action=togglePeriod]").text(),c=parseInt($(a.target).text(),10);"PM"===b&&(c+=12),g.date.hours(c),v.showPicker.call(g)},selectMinute:function(a){g.date.minutes(parseInt($(a.target).text(),10)),v.showPicker.call(g)},selectSecond:function(a){g.date.seconds(parseInt($(a.target).text(),10)),v.showPicker.call(g)}},w=function(a){var b=f(g.date),c=$(a.currentTarget).data("action"),d=v[c].apply(g,arguments);return x(a),g.date||(g.date=f({y:1970})),F(),t(),k(b,a.type),d},x=function(a){a.stopPropagation(),a.preventDefault()},y=function(a){f.lang(g.options.language);var b=$(a.target),c=f(g.date),d=f(b.val(),g.format,g.options.useStrict);d.isValid()&&!H(d)&&I(d)?(m(),g.setValue(d),k(c,a.type),F()):(g.viewDate=c,k(c,a.type),l(d),g.unset=!0)},z=function(a){a&&(g.viewMode=Math.max(g.minViewMode,Math.min(2,g.viewMode+a))),g.widget.find(".datepicker > div").hide().filter(".datepicker-"+M.modes[g.viewMode].clsName).show()},A=function(){var a,b,c,d,e;g.widget.on("click",".datepicker *",$.proxy(u,this)),g.widget.on("click","[data-action]",$.proxy(w,this)),g.widget.on("mousedown",$.proxy(x,this)),g.options.pickDate&&g.options.pickTime&&g.widget.on("click.togglePicker",".accordion-toggle",function(f){if(f.stopPropagation(),a=$(this),b=a.closest("ul"),c=b.find(".in"),d=b.find(".collapse:not(.in)"),c&&c.length){if(e=c.data("collapse"),e&&e.date)return;c.hide().removeClass("in"),d.show().addClass("in"),a.find("span").toggleClass(g.options.icons.time+" "+g.options.icons.date),g.element.find(".input-group-addon span").toggleClass(g.options.icons.time+" "+g.options.icons.date)}}),g.isInput?g.element.on({focus:$.proxy(g.show,this),change:$.proxy(y,this),blur:$.proxy(g.hide,this)}):(g.element.on({change:$.proxy(y,this)},"input"),g.component?g.component.on("click",$.proxy(g.show,this)):g.element.on("click",$.proxy(g.show,this)))},B=function(){$(window).on("resize.datetimepicker"+g.id,$.proxy(j,this)),g.isInput||$(document).on("mousedown.datetimepicker"+g.id,$.proxy(g.hide,this))},C=function(){g.widget.off("click",".datepicker *",g.click),g.widget.off("click","[data-action]"),g.widget.off("mousedown",g.stopEvent),g.options.pickDate&&g.options.pickTime&&g.widget.off("click.togglePicker"),g.isInput?g.element.off({focus:g.show,change:g.change}):(g.element.off({change:g.change},"input"),g.component?g.component.off("click",g.show):g.element.off("click",g.show))},D=function(){$(window).off("resize.datetimepicker"+g.id),g.isInput||$(document).off("mousedown.datetimepicker"+g.id)},E=function(){if(g.element){for(var a=g.element.parents(),b=!1,c=0;c<a.length;c++)if("fixed"===$(a[c]).css("position")){b=!0;break}return b}return!1},F=function(){f.lang(g.options.language);var a="";g.unset||(a=f(g.date).format(g.format)),i().val(a),g.element.data("date",a),g.options.pickTime||g.hide()},G=function(a,b,c){f.lang(g.options.language);var d;return"add"===a?(d=f(g.date),23===d.hours()&&d.add(c,b),d.add(c,b)):d=f(g.date).subtract(c,b),H(f(d.subtract(c,b)))||H(d)?void l(d.format(g.format)):("add"===a?g.date.add(c,b):g.date.subtract(c,b),void(g.unset=!1))},H=function(a){return f.lang(g.options.language),a.isAfter(g.options.maxDate)||a.isBefore(g.options.minDate)?!0:g.options.disabledDates===!1?!1:g.options.disabledDates[f(a).format("YYYY-MM-DD")]===!0},I=function(a){return f.lang(g.options.language),g.options.enabledDates===!1?!0:g.options.enabledDates[f(a).format("YYYY-MM-DD")]===!0},J=function(a){for(var b={},c=0,d=0;d<a.length;d++){var e=f(a[d]);e.isValid()&&(b[e.format("YYYY-MM-DD")]=!0,c++)}return c>0?b:!1},K=function(a){return a=a.toString(),a.length>=2?a:"0"+a},L=function(){if(g.options.pickDate&&g.options.pickTime){var a="";return a='<div class="bootstrap-datetimepicker-widget'+(g.options.sideBySide?" timepicker-sbs":"")+' dropdown-menu" style="z-index:9999 !important;">',a+=g.options.sideBySide?'<div class="row"><div class="col-sm-6 datepicker">'+M.template+'</div><div class="col-sm-6 timepicker">'+N.getTemplate()+"</div></div>":'<ul class="list-unstyled"><li'+(g.options.collapse?' class="collapse in"':"")+'><div class="datepicker">'+M.template+'</div></li><li class="picker-switch accordion-toggle"><a class="btn" style="width:100%"><span class="'+g.options.icons.time+'"></span></a></li><li'+(g.options.collapse?' class="collapse"':"")+'><div class="timepicker">'+N.getTemplate()+"</div></li></ul>",a+="</div>"}return g.options.pickTime?'<div class="bootstrap-datetimepicker-widget dropdown-menu"><div class="timepicker">'+N.getTemplate()+"</div></div>":'<div class="bootstrap-datetimepicker-widget dropdown-menu"><div class="datepicker">'+M.template+"</div></div>"},M={modes:[{clsName:"days",navFnc:"month",navStep:1},{clsName:"months",navFnc:"year",navStep:1},{clsName:"years",navFnc:"year",navStep:10}],headTemplate:'<thead><tr><th class="prev">&lsaquo;</th><th colspan="5" class="switch"></th><th class="next">&rsaquo;</th></tr></thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>'},N={hourTemplate:'<span data-action="showHours"   data-time-component="hours"   class="timepicker-hour"></span>',minuteTemplate:'<span data-action="showMinutes" data-time-component="minutes" class="timepicker-minute"></span>',secondTemplate:'<span data-action="showSeconds"  data-time-component="seconds" class="timepicker-second"></span>'};M.template='<div class="datepicker-days"><table class="table-condensed">'+M.headTemplate+'<tbody></tbody></table></div><div class="datepicker-months"><table class="table-condensed">'+M.headTemplate+M.contTemplate+'</table></div><div class="datepicker-years"><table class="table-condensed">'+M.headTemplate+M.contTemplate+"</table></div>",N.getTemplate=function(){return'<div class="timepicker-picker"><table class="table-condensed"><tr><td><a href="#" class="btn" data-action="incrementHours"><span class="'+g.options.icons.up+'"></span></a></td><td class="separator"></td><td>'+(g.options.useMinutes?'<a href="#" class="btn" data-action="incrementMinutes"><span class="'+g.options.icons.up+'"></span></a>':"")+"</td>"+(g.options.useSeconds?'<td class="separator"></td><td><a href="#" class="btn" data-action="incrementSeconds"><span class="'+g.options.icons.up+'"></span></a></td>':"")+(g.use24hours?"":'<td class="separator"></td>')+"</tr><tr><td>"+N.hourTemplate+'</td> <td class="separator">:</td><td>'+(g.options.useMinutes?N.minuteTemplate:'<span class="timepicker-minute">00</span>')+"</td> "+(g.options.useSeconds?'<td class="separator">:</td><td>'+N.secondTemplate+"</td>":"")+(g.use24hours?"":'<td class="separator"></td><td><button type="button" class="btn btn-primary" data-action="togglePeriod"></button></td>')+'</tr><tr><td><a href="#" class="btn" data-action="decrementHours"><span class="'+g.options.icons.down+'"></span></a></td><td class="separator"></td><td>'+(g.options.useMinutes?'<a href="#" class="btn" data-action="decrementMinutes"><span class="'+g.options.icons.down+'"></span></a>':"")+"</td>"+(g.options.useSeconds?'<td class="separator"></td><td><a href="#" class="btn" data-action="decrementSeconds"><span class="'+g.options.icons.down+'"></span></a></td>':"")+(g.use24hours?"":'<td class="separator"></td>')+'</tr></table></div><div class="timepicker-hours" data-action="selectHour"><table class="table-condensed"></table></div><div class="timepicker-minutes" data-action="selectMinute"><table class="table-condensed"></table></div>'+(g.options.useSeconds?'<div class="timepicker-seconds" data-action="selectSecond"><table class="table-condensed"></table></div>':"")},g.destroy=function(){C(),D(),g.widget.remove(),g.element.removeData("DateTimePicker"),g.component&&g.component.removeData("DateTimePicker")},g.show=function(a){if(g.options.useCurrent&&""===i().val())if(1!==g.options.minuteStepping){var b=f(),c=g.options.minuteStepping;b.minutes(Math.round(b.minutes()/c)*c%60).seconds(0),g.setValue(b.format(g.format))}else g.setValue(f().format(g.format));g.widget.show(),g.height=g.component?g.component.outerHeight():g.element.outerHeight(),j(),g.element.trigger({type:"dp.show",date:f(g.date)}),B(),a&&x(a)},g.disable=function(){var a=g.element.find("input");a.prop("disabled")||(a.prop("disabled",!0),C())},g.enable=function(){var a=g.element.find("input");a.prop("disabled")&&(a.prop("disabled",!1),A())},g.hide=function(a){if(!a||!$(a.target).is(g.element.attr("id"))){for(var b,c=g.widget.find(".collapse"),d=0;d<c.length;d++)if(b=c.eq(d).data("collapse"),b&&b.date)return;g.widget.hide(),g.viewMode=g.startViewMode,z(),g.element.trigger({type:"dp.hide",date:f(g.date)}),D()}},g.setValue=function(a){f.lang(g.options.language),a?g.unset=!1:(g.unset=!0,F()),f.isMoment(a)||(a=f(a,g.format)),a.isValid()?(g.date=a,F(),g.viewDate=f({y:g.date.year(),M:g.date.month()}),p(),t()):l(a)},g.getDate=function(){return g.unset?null:g.date},g.setDate=function(a){var b=f(g.date);g.setValue(a?a:null),k(b,"function")},g.setDisabledDates=function(a){g.options.disabledDates=J(a),g.viewDate&&m()},g.setEnabledDates=function(a){g.options.enabledDates=J(a),g.viewDate&&m()},g.setMaxDate=function(a){void 0!==a&&(g.options.maxDate=f(a),g.viewDate&&m())},g.setMinDate=function(a){void 0!==a&&(g.options.minDate=f(a),g.viewDate&&m())},h()}}}}]);